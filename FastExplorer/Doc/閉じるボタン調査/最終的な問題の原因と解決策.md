# 最終的な問題の原因と解決策

## 問題の症状

コンテキストメニューを表示した状態で閉じるボタンをクリックしても閉じない。閉じるボタン上をマウスを動かすとフォーカスが一瞬当たるが、すぐに外れてしまいクリックしても反応しない。

## 原因の分析

### 1. WindowChromeとメッセージフックの干渉
- `WindowChrome`はWPFの標準機能で、非クライアント領域のメッセージを処理する
- メッセージフックが`WindowChrome`の処理の前に呼ばれる可能性がある
- メッセージフックが呼ばれるだけで、`WindowChrome`の処理に影響を与える可能性がある

### 2. WM_NCHITTESTメッセージの頻繁な呼び出し
- `WM_NCHITTEST`は`WindowChrome`が頻繁に呼び出すメッセージ（マウス移動時に毎回呼ばれる）
- メッセージフックが呼ばれることで、処理順序が変わり、`WindowChrome`の処理が妨げられる可能性がある

### 3. メッセージフックの処理順序
- WPFのメッセージフックは、`WindowChrome`の処理の前に呼ばれる可能性がある
- メッセージフックで何も処理しなくても、メッセージフックが呼ばれることで処理順序が変わる可能性がある

## 現在の実装

1. **非クライアント領域のメッセージを完全にスキップ**
   - `switch`式を使用して、非クライアント領域のメッセージを即座にスキップ
   - `WM_NCHITTEST`、`WM_NCLBUTTONDOWN`などのメッセージを処理せず、`WindowChrome`に委譲

2. **メニュー関連のメッセージのみを処理**
   - `WM_INITMENUPOPUP`、`WM_DRAWITEM`、`WM_MEASUREITEM`、`WM_MENUCHAR`のみを処理

3. **TrackPopupMenuExが返った時点でリセット**
   - `ShowContextMenu`メソッド内で`TrackPopupMenuEx`が返った時点で`ResetMenuState()`を呼び出し

## 解決策の検討

### 1. メッセージフックを完全に削除（不可）
- `IContextMenu3`のメッセージ処理が必要なため、メッセージフックは必要
- メッセージフックを削除すると、`IContextMenu3`のメッセージ処理ができなくなる

### 2. メッセージフックを一時的に無効化（試行済み）
- メニュー表示中にメッセージフックを無効化する方法を試したが、`IContextMenu3`のメッセージ処理ができなくなる

### 3. メッセージフックの処理を最小限にする（現在の実装）
- 非クライアント領域のメッセージを完全にスキップ
- メニュー関連のメッセージのみを処理
- しかし、まだ問題が解決していない

## 根本的な原因

メッセージフックが呼ばれるだけで、`WindowChrome`の処理に影響を与える可能性があります。WPFのメッセージフックは、`WindowChrome`の処理の前に呼ばれる可能性があるため、メッセージフックで何も処理しなくても、メッセージフックが呼ばれることで処理順序が変わる可能性があります。

## 推奨される解決策

### オプション1: IContextMenu3のメッセージ処理を別の方法で行う
- `IContextMenu3`のメッセージ処理を、メッセージフックではなく、別の方法で行う
- しかし、`IContextMenu3`のメッセージ処理にはメッセージフックが必要なため、この方法は実現困難

### オプション2: WindowChromeの設定を変更
- `WindowChrome`の設定を変更して、メッセージフックとの干渉を避ける
- しかし、`WindowChrome`の設定を変更しても、メッセージフックとの干渉を完全に避けることは難しい

### オプション3: WPF-UIのバグとして報告
- この問題は、WPF-UIの`FluentWindow`とメッセージフックの干渉によるものと考えられる
- WPF-UIのGitHubリポジトリでIssueを報告することを検討

### オプション4: メッセージフックの処理順序を制御
- WPFのメッセージフックの処理順序を制御することは難しいため、この方法は実現困難

## 結論

この問題は、WPF-UIの`FluentWindow`とメッセージフックの干渉によるものと考えられます。メッセージフックが呼ばれるだけで、`WindowChrome`の処理に影響を与える可能性があります。

現在の実装では、非クライアント領域のメッセージを完全にスキップし、メニュー関連のメッセージのみを処理するようにしていますが、まだ問題が解決していない場合は、WPF-UIのバグとして報告することを検討してください。

